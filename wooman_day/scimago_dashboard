{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "f8436c90-ab1f-482d-9249-84cac2144608",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2026-02-05 17:29:00.491 WARNING streamlit.runtime.caching.cache_data_api: No runtime found, using MemoryCacheStorageManager\n",
      "2026-02-05 17:29:00.495 WARNING streamlit.runtime.caching.cache_data_api: No runtime found, using MemoryCacheStorageManager\n",
      "2026-02-05 17:29:00.496 WARNING streamlit.runtime.scriptrunner_utils.script_run_context: Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:01.486 \n",
      "  \u001b[33m\u001b[1mWarning:\u001b[0m to view this Streamlit app on a browser, run it with the following\n",
      "  command:\n",
      "\n",
      "    streamlit run D:\\anaconda\\Lib\\site-packages\\ipykernel_launcher.py [ARGUMENTS]\n",
      "2026-02-05 17:29:01.488 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:01.491 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:02.000 Thread 'Thread-3': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:02.006 Thread 'Thread-3': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.916 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.918 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.922 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.923 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.924 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.926 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.927 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.929 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.930 Session state does not function when running a script without `streamlit run`\n",
      "2026-02-05 17:29:03.932 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.933 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.935 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:03.936 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "C:\\Users\\Alexander\\AppData\\Local\\Temp\\ipykernel_20992\\3852001879.py:52: MatplotlibDeprecationWarning: The 'labels' parameter of boxplot() has been renamed 'tick_labels' since Matplotlib 3.9; support for the old name will be dropped in 3.11.\n",
      "  ax.boxplot(\n",
      "2026-02-05 17:29:04.292 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.611 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.612 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.673 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.674 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.677 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.679 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.680 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.682 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.683 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:05.684 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "C:\\Users\\Alexander\\AppData\\Local\\Temp\\ipykernel_20992\\3852001879.py:88: MatplotlibDeprecationWarning: The 'labels' parameter of boxplot() has been renamed 'tick_labels' since Matplotlib 3.9; support for the old name will be dropped in 3.11.\n",
      "  ax.boxplot(\n",
      "2026-02-05 17:29:05.868 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:06.664 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n",
      "2026-02-05 17:29:06.665 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.\n"
     ]
    }
   ],
   "source": [
    "import streamlit as st\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "import textwrap\n",
    "\n",
    "# --- Загрузка данных ---\n",
    "@st.cache_data\n",
    "def load_data():\n",
    "    scimagojr_2024 = pd.read_csv('scimagojr 2024.csv', sep=';')\n",
    "    scimagojr_2023 = pd.read_csv('scimagojr 2023.csv', sep=';')\n",
    "    scimagojr_2022 = pd.read_csv('scimagojr 2022.csv', sep=';')\n",
    "\n",
    "    scimagojr_2022['Year'] = 2022\n",
    "    scimagojr_2023['Year'] = 2023\n",
    "    scimagojr_2024['Year'] = 2024\n",
    "\n",
    "    df = pd.concat([scimagojr_2022, scimagojr_2023, scimagojr_2024])\n",
    "    df['%Female'] = df['%Female'].str.replace(',', '.', regex=False).astype(float)\n",
    "\n",
    "    # Разделяем Areas\n",
    "    df['Areas'] = df['Areas'].str.split(';')\n",
    "    df = df.explode('Areas')\n",
    "    df['Areas'] = df['Areas'].str.strip()\n",
    "\n",
    "    # Чистка\n",
    "    df = df.dropna(subset=['%Female', 'Areas', 'Year'])\n",
    "    return df\n",
    "\n",
    "df = load_data()\n",
    "\n",
    "# --- Функции для визуализации ---\n",
    "def wrap_label(label, width=25):\n",
    "    return textwrap.fill(label, width=width)\n",
    "\n",
    "def plot_boxplot_top_areas(df, year, top_n=10):\n",
    "    df_year = df[df['Year'] == year]\n",
    "    \n",
    "    # топ Areas по медиане\n",
    "    top_areas = df_year.groupby('Areas')['%Female'].median().sort_values(ascending=False).head(top_n).index\n",
    "    df_top = df_year[df_year['Areas'].isin(top_areas)]\n",
    "\n",
    "    grouped = []\n",
    "    labels = []\n",
    "    for area, group in df_top.groupby('Areas'):\n",
    "        grouped.append(group['%Female'].values)\n",
    "        labels.append(wrap_label(area))\n",
    "\n",
    "    plt.figure(figsize=(16, 8), facecolor='black')\n",
    "    ax = plt.gca()\n",
    "    ax.set_facecolor('black')\n",
    "    \n",
    "    ax.boxplot(\n",
    "        grouped,\n",
    "        labels=labels,\n",
    "        patch_artist=False,\n",
    "        boxprops=dict(color='white'),\n",
    "        whiskerprops=dict(color='white'),\n",
    "        capprops=dict(color='white'),\n",
    "        medianprops=dict(color='white'),\n",
    "        flierprops=dict(marker='o', markerfacecolor='white', markeredgecolor='white', markersize=5, alpha=0.8)\n",
    "    )\n",
    "\n",
    "    ax.set_title(f'Распределение доли женщин-авторов (%Female) по Areas\\nТоп-{top_n} по медиане, {year} год',\n",
    "                 color='white', fontsize=15)\n",
    "    ax.tick_params(axis='x', colors='white', labelsize=12, rotation=22)\n",
    "    ax.tick_params(axis='y', colors='white')\n",
    "    for spine in ax.spines.values():\n",
    "        spine.set_color('white')\n",
    "    plt.tight_layout()\n",
    "    st.pyplot(plt.gcf())\n",
    "    plt.close()\n",
    "\n",
    "def plot_boxplot_by_quartile(df, year, area):\n",
    "    df_area = df[(df['Year'] == year) & (df['Areas'] == area)]\n",
    "    grouped = []\n",
    "    labels = []\n",
    "\n",
    "    for quartile, group in df_area.groupby('SJR Best Quartile'):\n",
    "        grouped.append(group['%Female'].values)\n",
    "        labels.append(quartile)\n",
    "\n",
    "    if not grouped:\n",
    "        st.write(\"Нет данных для выбранного Area и года.\")\n",
    "        return\n",
    "\n",
    "    plt.figure(figsize=(10, 6))\n",
    "    ax = plt.gca()\n",
    "    ax.boxplot(\n",
    "        grouped,\n",
    "        labels=labels,\n",
    "        patch_artist=True,\n",
    "        boxprops=dict(facecolor='lightblue', color='blue'),\n",
    "        whiskerprops=dict(color='blue'),\n",
    "        capprops=dict(color='blue'),\n",
    "        medianprops=dict(color='red'),\n",
    "        flierprops=dict(marker='o', markerfacecolor='blue', markeredgecolor='blue', markersize=5, alpha=0.7)\n",
    "    )\n",
    "    ax.set_title(f'%Female по квартилям для {area}, {year} год')\n",
    "    plt.tight_layout()\n",
    "    st.pyplot(plt.gcf())\n",
    "    plt.close()\n",
    "\n",
    "# --- Streamlit интерфейс ---\n",
    "st.title(\"Анализ доли женщин-авторов по областям исследований\")\n",
    "\n",
    "year = st.selectbox(\"Выберите год\", [2022, 2023, 2024])\n",
    "st.subheader(\"Топ Areas по медиане доли женщин\")\n",
    "plot_boxplot_top_areas(df, year)\n",
    "\n",
    "# Выбор Area для детализации\n",
    "areas_available = df[df['Year'] == year]['Areas'].unique()\n",
    "selected_area = st.selectbox(\"Выберите Area для детальной разбивки по квартилям\", areas_available)\n",
    "\n",
    "st.subheader(f\"Детализация по квартилям для {selected_area}\")\n",
    "plot_boxplot_by_quartile(df, year, selected_area)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f6fbac06-53b4-41c6-b016-da4553f83c42",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python [conda env:base] *",
   "language": "python",
   "name": "conda-base-py"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
